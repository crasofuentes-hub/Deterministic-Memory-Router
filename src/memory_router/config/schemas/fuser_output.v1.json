{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "fuser_output.v1",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema_id", "config_version", "trace_id", "active_preferences", "preferences_history", "relevant_code", "conversation_facts", "notes"],
  "properties": {
    "schema_id": { "type": "string", "const": "fuser_output.v1" },
    "config_version": { "type": "string", "minLength": 1 },
    "trace_id": { "type": "string", "minLength": 1 },

    "active_preferences": {
      "type": "array",
      "maxItems": 20,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["pref", "since"],
        "properties": {
          "pref": { "type": "string", "minLength": 1, "maxLength": 120 },
          "since": { "type": "string", "minLength": 4, "maxLength": 40 }
        }
      }
    },

    "preferences_history": {
      "type": "array",
      "maxItems": 50,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["pref", "status", "revoked_by", "revoked_at"],
        "properties": {
          "pref": { "type": "string", "minLength": 1, "maxLength": 120 },
          "status": { "type": "string", "enum": ["obsolete", "superseded", "uncertain"] },
          "revoked_by": { "type": "string", "minLength": 1, "maxLength": 120 },
          "revoked_at": { "type": "string", "minLength": 4, "maxLength": 40 }
        }
      }
    },

    "relevant_code": {
      "type": "array",
      "maxItems": 20,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["summary", "snippet_ref"],
        "properties": {
          "summary": { "type": "string", "minLength": 1, "maxLength": 160 },
          "snippet_ref": { "type": "string", "minLength": 1, "maxLength": 80 }
        }
      }
    },

    "conversation_facts": {
      "type": "array",
      "maxItems": 30,
      "items": { "type": "string", "minLength": 1, "maxLength": 180 }
    },

    "notes": {
      "type": "array",
      "maxItems": 30,
      "items": { "type": "string", "minLength": 1, "maxLength": 200 }
    }
  }
}